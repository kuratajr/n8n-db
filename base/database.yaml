# databases/n8n/base/database.yaml
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: n8n-db
spec:
  # 3 pod (1 primary + 2 replicas)
  instances: 3

  # PostgreSQL image (b·∫°n c√≥ th·ªÉ d√πng ghcr.io/cloudnative-pg/postgresql:16)
  imageName: quay.io/enterprisedb/postgresql:16.1

  # Storage (m·ªói pod c√≥ volume ri√™ng, provisioned b·ªüi Longhorn)
  storage:
    size: 10Gi
    storageClass: longhorn

  postgresql:
    parameters:
      max_connections: "100"
      shared_buffers: "512MB"

  bootstrap:
    initdb:
      database: n8n
      owner: n8n_user
      secret:
        name: n8n-db-secret

  monitoring:
    enabled: true

  resources:
    requests:
      cpu: "500m"
      memory: "1Gi"
    limits:
      cpu: "2"
      memory: "4Gi"

  # üîπ R√†ng bu·ªôc node
  nodeSelector:
    longhorn.io/node: "true"

  # üîπ Tr√°nh ƒë·∫∑t nhi·ªÅu pod CNPG tr√™n c√πng 1 node
  affinity:
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchExpressions:
          - key: postgresql
            operator: In
            values:
              - n8n-db
        topologyKey: "kubernetes.io/hostname"
